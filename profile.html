<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Swayam</title>
    <link rel="stylesheet" href="public/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav id="navigation" class="nav-solid">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="logo-link">
                    <div class="logo-icon"><span class="logo-symbol">स्व</span></div>
                    <div class="logo-text">
                        <span class="logo-title">Swayam</span>
                        <span class="logo-subtitle">Journey Within</span>
                    </div>
                </a>
                <div class="nav-links">
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="profile.html" class="nav-link active">Profile</a>
                    <div class="lang-dropdown">
                        <button class="lang-btn" id="langBtn">EN ▼</button>
                        <ul class="lang-options" id="langOptions">
                            <li data-lang="EN" class="active">English</li>
                            <li data-lang="HI">हिंदी</li>
                            <li data-lang="MR">मराठी</li>
                        </ul>
                    </div>
                    <span class="user-name" id="userName">User</span>
                    <button onclick="logout()" class="btn-secondary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="dashboard-main">
        <div class="container">
            <div class="max-w-4xl mx-auto">
                <div class="dashboard-header">
                    <h1>My Profile</h1>
                    <p>Manage your account settings and preferences</p>
                </div>

                <div class="profile-grid">
                    <!-- Profile Info -->
                    <div class="glass-card">
                        <h3>Profile Information</h3>
                        <form id="profileForm">
                            <div class="form-group">
                                <label for="name">Full Name</label>
                                <input type="text" id="name" name="name" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" required readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="language">Preferred Language</label>
                                <select id="language" name="language">
                                    <option value="en">English</option>
                                    <option value="hi">हिंदी</option>
                                    <option value="mr">मराठी</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn-primary">Update Profile</button>
                        </form>
                    </div>

                    <!-- Change Password -->
                    <div class="glass-card">
                        <h3>Change Password</h3>
                        <form id="passwordForm">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" name="currentPassword" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" name="newPassword" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required>
                            </div>
                            
                            <button type="submit" class="btn-primary">Change Password</button>
                        </form>
                    </div>

                    <!-- Account Stats -->
                    <div class="glass-card">
                        <h3>Account Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number" id="totalBlogs">0</div>
                                <div class="stat-label">Total Blogs</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="publishedBlogs">0</div>
                                <div class="stat-label">Published</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalViews">0</div>
                                <div class="stat-label">Total Views</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="memberSince">-</div>
                                <div class="stat-label">Member Since</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="public/js/auth.js"></script>
    <script>
        if (!isLoggedIn()) {
            window.location.href = 'login.html';
        }

        const user = getCurrentUser();
        if (user) {
            document.getElementById('userName').textContent = user.name;
            loadProfile();
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadUserStats();
        });

        async function loadProfile() {
            try {
                const response = await fetch('api/profile.php');
                const result = await response.json();
                
                if (result.success) {
                    const profile = result.profile;
                    document.getElementById('name').value = profile.name;
                    document.getElementById('email').value = profile.email;
                    document.getElementById('language').value = profile.language;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch('api/user-stats.php');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('totalBlogs').textContent = stats.totalBlogs || 0;
                    document.getElementById('publishedBlogs').textContent = stats.publishedBlogs || 0;
                    document.getElementById('totalViews').textContent = stats.totalViews || 0;
                    document.getElementById('memberSince').textContent = new Date(stats.memberSince).getFullYear();
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                name: formData.get('name'),
                language: formData.get('language')
            };
            
            try {
                const response = await fetch('api/update-profile.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Profile updated successfully!');
                    // Update local storage
                    const currentUser = getCurrentUser();
                    currentUser.name = data.name;
                    currentUser.language = data.language;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    document.getElementById('userName').textContent = data.name;
                } else {
                    alert(result.message || 'Failed to update profile');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        });

        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            const data = {
                currentPassword: formData.get('currentPassword'),
                newPassword: newPassword
            };
            
            try {
                const response = await fetch('api/change-password.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Password changed successfully!');
                    this.reset();
                } else {
                    alert(result.message || 'Failed to change password');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        });
    </script>

    <style>
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .profile-grid .glass-card:last-child {
            grid-column: 1 / -1;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            text-align: center;
        }
        .stat-item {
            padding: 1rem;
            background: var(--color-cream);
            border-radius: var(--radius-md);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-rose);
            margin-bottom: 0.5rem;
        }
        .stat-label {
            font-size: 0.875rem;
            color: var(--color-grey);
        }
        @media (max-width: 768px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</body>
</html>